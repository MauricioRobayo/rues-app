import { Badge } from "@/app/[company]/Badge";
import { Copy } from "@/app/[company]/CopyButton";
import { getCompanyRecordFromPathSegment } from "@/app/[company]/getCompanyRecordFromPathSegment";
import { getRuesDataByNit } from "@/app/[company]/rues";
import { formatNit } from "@/app/format-nit";
import { dateFormatter } from "@/app/formatters";
import { formatDistanceToNowStrict } from "date-fns";
import { es } from "date-fns/locale/es";
import type { Metadata } from "next";
import { getVerificationDigit } from "nit-verifier";

interface PageProps {
  params: Promise<{ company: string }>;
}

export const dynamic = "force-static";

export async function generateMetadata({
  params,
}: PageProps): Promise<Metadata> {
  const { company } = await params;
  const companyRecord = await getCompanyRecordFromPathSegment(company);
  const formattedNit = formatNit(companyRecord.nit);
  return {
    title: `${companyRecord.businessName} - NIT ${formattedNit}`,
    // description: "Generated by create next app",
  };
}

export default async function page({ params }: PageProps) {
  const { company } = await params;
  const companyRecord = await getCompanyRecordFromPathSegment(company);
  const formattedNit = formatNit(companyRecord.nit);
  const dv = getVerificationDigit(companyRecord.nit);
  const registrationDate = dateFormatter.format(companyRecord.registrationDate);
  const ruesData = await getRuesDataByNit(companyRecord.nit);
  const status = ruesData?.details?.estado;

  console.log(ruesData);

  return (
    <article itemScope itemType="https://schema.org/Organization">
      <header className="py-8">
        <h1
          itemProp="name"
          className="text-balance text-2xl font-semibold text-brand"
        >
          {companyRecord.businessName}
        </h1>
        <div className="flex items-center gap-2">
          <h2 className="">NIT: {formattedNit}</h2>
          {!!status && (
            <Badge variant={status === "ACTIVA" ? "success" : "error"}>
              Matrícula {status}
            </Badge>
          )}
        </div>
      </header>
      <section>
        <p>
          <strong>Razón Social:</strong> {companyRecord.businessName}
        </p>
        <p>
          <strong>NIT:</strong>{" "}
          <div className="inline-block">
            <div className="flex gap-2">
              <span itemProp="taxID">{companyRecord.nit}</span>
              <Copy
                value={String(companyRecord.nit)}
                className="rounded bg-slate-800 px-2 text-sm text-white"
              />
            </div>
          </div>
        </p>
        <p>
          <strong>DV:</strong> {dv}
        </p>
        <p>
          <strong>Activa:</strong>{" "}
          <span itemProp="isicV4">{status === "ACTIVA" ? "Sí" : "No"}</span>
        </p>
        <p>
          <strong>Categoría:</strong> {companyRecord.category}
        </p>
        <p>
          <strong>Organización Jurídica:</strong> {companyRecord.legalEntity}
        </p>
        <p>
          <strong>Fecha de Constitución:</strong>{" "}
          <time dateTime={companyRecord.registrationDate.toISOString()}>
            {registrationDate}
          </time>
        </p>
        <p>
          <strong>Antigüedad:</strong>{" "}
          {formatDistanceToNowStrict(companyRecord.registrationDate, {
            locale: es,
          })}
        </p>
        <p>
          <strong>Dirección:</strong>{" "}
          <span itemProp="address">{companyRecord.businessAddress}</span>
        </p>
        <p>
          <strong>Ciudad:</strong>{" "}
          <span itemProp="address">{companyRecord.city}</span>
        </p>
        <p>
          <strong>Departamento:</strong>{" "}
          <span itemProp="address">{companyRecord.state}</span>
        </p>
        <p>
          <strong>Tamaño de la empresa:</strong>
          <span itemProp="numberOfEmployees">{companyRecord.companySize}</span>
        </p>
        <section>
          <h2>Actividad Económica</h2>
          <ul>
            <li>{companyRecord.economicActivity1}</li>
            <li>{companyRecord.economicActivity2}</li>
            <li>{companyRecord.economicActivity3}</li>
            <li>{companyRecord.economicActivity4}</li>
          </ul>
        </section>
      </section>
    </article>
  );
}
